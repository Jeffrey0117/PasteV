# Smart Mode 重設計規格

## 問題

目前 SmartModePage 有 6 個步驟，太多且不合理：
1. upload - 上傳
2. detect - 偵測 ← **多餘，應該背景自動做**
3. fields - 欄位
4. edit - 編輯
5. translate - 翻譯 ← **多餘，應該在 edit 內一鍵完成**
6. preview - 預覽

## 新設計：4 步流程

```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│  上傳    │ →  │  欄位    │ →  │  編輯    │ →  │  預覽    │
│ upload   │    │ fields   │    │  edit    │    │ preview  │
└──────────┘    └──────────┘    └──────────┘    └──────────┘
     │               │               │               │
     ▼               ▼               ▼               ▼
  拖放圖片       定義欄位        表格編輯         輸出
  背景OCR       AI解析(1次)    批次翻譯(1次)    批次下載
```

---

## 步驟詳解

### Step 1: 上傳 (upload)

**功能：**
- 拖放或點擊上傳多張圖片
- 上傳後立即背景執行 OCR（Tesseract，0 API 呼叫）
- 進度條顯示 OCR 進度
- 全部 OCR 完成後自動進入下一步

**UI：**
```
┌─────────────────────────────────────────────────────────────┐
│  Smart Mode                                                 │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌───┐                      │
│  │  1  │ │  2  │ │  3  │ │ ... │ │ + │  ← 縮圖 + 新增按鈕    │
│  │ ✓   │ │ ⏳  │ │ ⏳  │ │     │ │   │                      │
│  └─────┘ └─────┘ └─────┘ └─────┘ └───┘                      │
│                                                             │
│  ████████████████░░░░░░░░  OCR: 2/5 完成                    │
│                                                             │
│                                    [ 下一步：定義欄位 → ]    │
└─────────────────────────────────────────────────────────────┘
```

**觸發條件：**
- 下一步按鈕：至少 1 張圖片 + 全部 OCR 完成

---

### Step 2: 欄位定義 (fields)

**功能：**
- 左側：第一張圖片預覽
- 右側：欄位列表（可新增/刪除/重新命名）
- 預設欄位：帳號、ID（可自訂）
- 點「開始解析」呼叫 AI 批次解析 API（1 次 API）

**UI：**
```
┌─────────────────────────────────────────────────────────────┐
│  Smart Mode - 定義欄位                                      │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────┐    ┌────────────────────────────┐  │
│  │                     │    │  欄位列表：                 │  │
│  │   [第一張圖預覽]    │    │                            │  │
│  │                     │    │  1. 帳號     [✕]           │  │
│  │   linlinya_1214     │    │  2. ID       [✕]           │  │
│  │   1,234 粉絲        │    │  3. 粉絲數   [✕]           │  │
│  │                     │    │                            │  │
│  └─────────────────────┘    │  [+ 新增欄位]              │  │
│                             │                            │  │
│                             │  ─────────────────────     │  │
│                             │  共 5 張圖片                │  │
│                             │  將解析 3 個欄位            │  │
│                             └────────────────────────────┘  │
│                                                             │
│  [ ← 上一步 ]                      [ 開始 AI 解析 → ]       │
└─────────────────────────────────────────────────────────────┘
```

**AI 批次解析 API（1 次呼叫）：**
```json
POST /api/ai-parse
{
  "fields": ["帳號", "ID", "粉絲數"],
  "images": [
    { "id": "img1", "ocrText": "linlinya_1214\n1,234 followers" },
    { "id": "img2", "ocrText": "user_abc\n5,678 followers" },
    ...
  ]
}

Response:
{
  "results": {
    "img1": { "帳號": "linlinya_1214", "ID": "", "粉絲數": "1,234" },
    "img2": { "帳號": "user_abc", "ID": "", "粉絲數": "5,678" },
    ...
  }
}
```

---

### Step 3: 編輯 (edit)

**功能：**
- 表格顯示：圖片縮圖 | 欄位1原文 | 欄位1譯文 | 欄位2原文 | ...
- Tab 切換欄位（只顯示當前欄位的原文/譯文）
- 「翻譯此欄位」按鈕：翻譯當前 tab 的所有原文
- 「翻譯全部」按鈕：翻譯所有欄位
- 可手動編輯任何儲存格

**UI：**
```
┌─────────────────────────────────────────────────────────────┐
│  Smart Mode - 編輯資料                                      │
├─────────────────────────────────────────────────────────────┤
│  [帳號] [ID] [粉絲數]  ← Tab 切換                           │
│                                                             │
│  ┌────────┬─────────────────────┬─────────────────────┐     │
│  │ 圖片   │ 原文                │ 翻譯                │     │
│  ├────────┼─────────────────────┼─────────────────────┤     │
│  │ [1]    │ linlinya_1214       │ (尚未翻譯)          │     │
│  │ [2]    │ user_abc            │ (尚未翻譯)          │     │
│  │ [3]    │ test_user           │ (尚未翻譯)          │     │
│  │ [4]    │ hello_world         │ (尚未翻譯)          │     │
│  │ [5]    │ cool_name_123       │ (尚未翻譯)          │     │
│  └────────┴─────────────────────┴─────────────────────┘     │
│                                                             │
│  [翻譯此欄位]  [翻譯全部]                                    │
│                                                             │
│  [ ← 上一步 ]                            [ 預覽輸出 → ]      │
└─────────────────────────────────────────────────────────────┘
```

**批次翻譯 API（1 次呼叫）：**
```json
POST /api/translate-batch
{
  "texts": [
    { "key": "img1:帳號", "text": "linlinya_1214" },
    { "key": "img2:帳號", "text": "user_abc" },
    ...
  ],
  "targetLang": "zh-TW"
}

Response:
{
  "translations": {
    "img1:帳號": "linlinya_1214",  // 專有名詞保留
    "img2:帳號": "user_abc",
    ...
  }
}
```

---

### Step 4: 預覽 (preview)

**功能：**
- 左右切換圖片
- 顯示套用模板後的預覽
- 可調整文字位置/大小（可選）
- 「輸出此張」/ 「輸出全部 (ZIP)」

**UI：**
```
┌─────────────────────────────────────────────────────────────┐
│  Smart Mode - 預覽輸出                                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ← 上一張    [ 1 / 5 ]    下一張 →                          │
│                                                             │
│  ┌──────────────────────────────────────────────────────┐   │
│  │                                                      │   │
│  │           ┌─────────────────────────┐                │   │
│  │           │    linlinya_1214        │                │   │
│  │           │    1,234 粉絲           │                │   │
│  │           └─────────────────────────┘                │   │
│  │                                                      │   │
│  │                    [原始圖片]                         │   │
│  │                                                      │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                             │
│  [原文/譯文 切換]  [縮放: 100%]                              │
│                                                             │
│  [ 輸出此張 ]                    [ 輸出全部 (ZIP) ]          │
└─────────────────────────────────────────────────────────────┘
```

---

## API 呼叫統計

| 步驟 | API 呼叫 | 說明 |
|------|----------|------|
| upload | 0 | 本地 Tesseract OCR |
| fields | **1** | AI 批次解析所有圖片 |
| edit | **1** | 批次翻譯所有欄位 |
| preview | 0 | 本地 html2canvas 渲染 |
| **總計** | **2** | 不論圖片數量 |

---

## 程式碼變更

### 1. 移除的步驟
- `detect` - OCR 改為背景自動執行
- `translate` - 翻譯整合到 edit 步驟

### 2. SmartStep 型別
```typescript
// 舊
type SmartStep = 'upload' | 'detect' | 'fields' | 'edit' | 'translate' | 'preview';

// 新
type SmartStep = 'upload' | 'fields' | 'edit' | 'preview';
```

### 3. 新增功能
- edit 步驟加入 Tab 切換欄位
- edit 步驟加入「翻譯此欄位」/「翻譯全部」按鈕
- preview 步驟加入左右切換、縮放控制

### 4. UI 改進
- Step indicator 減少為 4 步
- 更清晰的進度提示
- 表格編輯改用 Tab 分欄位

---

## 實作優先順序

1. [ ] 修改 SmartStep 型別（4 步）
2. [ ] upload 步驟：背景 OCR + 進度條
3. [ ] fields 步驟：欄位列表 + 圖片預覽
4. [ ] edit 步驟：Tab 切換 + 表格編輯 + 翻譯按鈕
5. [ ] preview 步驟：切換 + 縮放 + 輸出
6. [ ] 調整 CSS 樣式
